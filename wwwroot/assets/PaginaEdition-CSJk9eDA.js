import{j as I,r as _,o as j,A as F,z as T,c as p,a as d,H as z,d as o,t as h,F as x,g as $,_ as L,k as N,b as V,w as R,e as X,B as Y}from"./index-Vd5CoYyF.js";import{N as H}from"./NavbarAdmin-h5m7T1ln.js";import{a as W}from"./index-Dq7h7Pqt.js";const G={class:"bloque-header"},J={class:"bloque-titulo"},K={class:"acciones-globales"},Q={class:"productos-simple"},Z=["src"],tt={class:"producto-detalle"},et={class:"precio"},ot={class:"acciones"},at=["onClick"],nt=["onClick"],rt=I({__name:"BloqueEditor",props:{bloque:{},productos:{}},emits:["update","delete","delete-producto","editar-producto"],setup(s,{emit:a}){const i=s,g=a,c=_({...i.bloque}),f=_(!1),w=_({x:0,y:0});function B(n){n.target instanceof HTMLElement&&n.target.closest(".acciones, .acciones-globales")||(f.value=!0,w.value={x:n.clientX-c.value.x,y:n.clientY-c.value.y},n.preventDefault())}function y(n){f.value&&(c.value.x=Math.max(0,n.clientX-w.value.x),c.value.y=Math.max(0,n.clientY-w.value.y),g("update",{...c.value}))}function C(){f.value=!1}j(()=>{window.addEventListener("mousemove",y),window.addEventListener("mouseup",C)}),F(()=>{window.removeEventListener("mousemove",y),window.removeEventListener("mouseup",C)});function b(n){return i.productos.find(u=>u.uuid===n)}function q(n){const u=b(n);return u?.imagenUrl?.startsWith("http")?u.imagenUrl:`https://lecturasdjazz-api.onrender.com${u?.imagenUrl||""}`}function E(n){return b(n)?.titulo||"Desconocido"}function U(n){const u=b(n);return u?.enOferta?(u.precio*(1-(u.porcentajeOferta||0)/100)).toFixed(2):u?.precio.toFixed(2)}function D(n){c.value.productosUuids=c.value.productosUuids.filter(u=>u!==n),g("update",{...c.value}),g("delete-producto",n)}function P(n){const u=b(n);g("editar-producto",u)}return T(()=>i.bloque,n=>{c.value={...n}},{deep:!0}),(n,u)=>(d(),p("div",{class:"bloque-editor minimal",style:z({position:"absolute",left:`${c.value.x}px`,top:`${c.value.y}px`,width:`${c.value.width}px`,minHeight:`${c.value.height}px`,zIndex:10}),onMousedown:B},[o("div",G,[o("h3",J,h(n.bloque.titulo),1),o("div",K,[o("button",{onClick:u[0]||(u[0]=m=>g("delete"))},"🗑️ Eliminar Bloque")])]),o("div",Q,[(d(!0),p(x,null,$(c.value.productosUuids,m=>(d(),p("div",{key:m,class:"producto-card"},[o("img",{src:q(m),alt:"Producto"},null,8,Z),o("div",tt,[o("h3",null,h(E(m)),1),o("p",et,"$"+h(U(m)),1)]),o("div",ot,[o("button",{onClick:S=>P(m)},"✏️",8,at),o("button",{onClick:S=>D(m)},"🗑️",8,nt)])]))),128))])],36))}}),it=L(rt,[["__scopeId","data-v-8ea6f479"]]),k=W.create({baseURL:"import.meta.env.VITE_API_URL/api/admin",timeout:1e4,headers:{"Content-Type":"application/json",Accept:"application/json"}});async function st(){try{const{data:s}=await k.get("/configuracion-servicios");return s.map(a=>({id:a.id,titulo:a.titulo,subtitulo:a.subtitulo??"",productosUuids:a.productosUuids?a.productosUuids.split(","):[],orden:a.orden??0,fechaCreacion:a.fechaCreacion??new Date().toISOString(),x:a.x??0,y:a.y??0,width:a.width??300,height:a.height??200}))}catch(s){throw console.error("Error al obtener bloques:",s),new Error("No se pudieron cargar los bloques de configuración")}}async function ut(s){try{const a={...s,productosUuids:s.productosUuids.join(",")};if(s.id===0){const{data:i}=await k.post("/configuracion-servicios",a);return{...s,id:i.id}}else return await k.put(`/configuracion-servicios/${s.id}`,a),s}catch(a){throw console.error("Error al guardar bloque:",a),new Error("No se pudo guardar el bloque")}}async function ct(s){try{await k.delete(`/configuracion-servicios/${s}`)}catch(a){throw console.error("Error al eliminar bloque:",a),new Error("No se pudo eliminar el bloque")}}async function lt(){try{const{data:s}=await k.get("/productos");return s.filter(a=>a.activo)}catch(s){throw console.error("Error al obtener productos:",s),new Error("No se pudieron cargar los productos")}}const dt={class:"pagina-editor"},pt={class:"editor-container"},vt={class:"toolbar"},ht={key:0,class:"vista-previa"},gt={class:"previa-container"},ft={class:"subtitulo"},mt={class:"productos-grid"},_t=["src"],wt={class:"precio"},yt={key:1,class:"workspace"},bt={class:"panel-lateral"},xt={class:"categorias"},$t=["onClick"],Ct={key:0,class:"productos-categoria"},kt=["onDragstart"],Bt=["src"],qt=["onClick"],Et=I({__name:"PaginaEdition",setup(s){const a=_([]),i=_([]),g=_(!1),c=_(null),f=_(null),w=_(null);j(async()=>{a.value=await lt(),await M()});const B=N(()=>{const t=new Set(a.value.map(e=>e.categoria||"Sin categoría"));return Array.from(t).sort()}),y=N(()=>{const t={};return a.value.forEach(e=>{const r=e.categoria||"Sin categoría";t[r]||(t[r]=[]),t[r].push(e)}),t});function C(t){return t?.startsWith("http")?t:`https://lecturasdjazz-api.onrender.com${t}`}function b(t){return t.enOferta?(t.precio*(1-(t.porcentajeOferta||0)/100)).toFixed(2):t.precio.toFixed(2)}function q(t){return t.productosUuids.map(e=>a.value.find(r=>r.uuid===e)).filter(Boolean)}function E(t){return{position:"absolute",left:`${t.x}px`,top:`${t.y}px`,width:`${t.width}px`,minHeight:`${t.height}px`}}function U(){g.value=!g.value}function D(t){c.value=c.value===t?null:t}function P(){const t=w.value?.getBoundingClientRect(),e={id:0,titulo:"Nuevo Bloque",subtitulo:"",productosUuids:[],orden:i.value.length,fechaCreacion:new Date().toISOString(),x:t?t.width/2-150:100,y:100+i.value.length*30,width:300,height:200};i.value.push(e)}function n(t,e){i.value=i.value.map((r,l)=>l===t?e:r)}async function u(t){const e=i.value[t];e.id&&e.id>0&&await ct(e.id),i.value.splice(t,1)}function m(t,e){f.value=e,t.dataTransfer?.setData("text/plain","")}function S(t){const r=y.value[t].map(v=>v.uuid),l={id:0,titulo:t,subtitulo:`Todos los productos de ${t}`,productosUuids:r,orden:i.value.length,fechaCreacion:new Date().toISOString(),x:100,y:100+i.value.length*30,width:400,height:300};i.value.push(l)}function A(t){if(!f.value||!w.value)return;const e=w.value.getBoundingClientRect(),r=t.clientX-e.left,l=t.clientY-e.top,v={id:0,titulo:f.value.titulo,subtitulo:f.value.descripcion,productosUuids:[f.value.uuid],orden:i.value.length,fechaCreacion:new Date().toISOString(),x:Math.max(0,r-50),y:Math.max(0,l-50),width:300,height:200};i.value.push(v),f.value=null}async function M(){i.value=[];const t=await st();i.value=t.map(e=>({...e,x:e.posX,y:e.posY,width:e.ancho,height:e.alto}))}async function O(){try{for(const t of i.value){const e=await ut({...t,posX:t.x,posY:t.y,ancho:t.width,alto:t.height});t.id===0&&(t.id=e.id)}alert("Configuración guardada correctamente")}catch(t){console.error("Error al guardar:",t),alert("Error al guardar la configuración")}}return(t,e)=>(d(),p("div",dt,[V(H),o("div",pt,[e[2]||(e[2]=o("h1",{class:"titulo"},"🛠️ Editor de Página de Servicios",-1)),o("div",vt,[o("button",{onClick:U,class:"btn btn-preview"}," 👁️ "+h(g.value?"Salir de vista previa":"Vista previa"),1),o("button",{onClick:P,class:"btn btn-add"}," ➕ Nuevo Bloque "),o("button",{onClick:O,class:"btn btn-save"}," 💾 Guardar ")]),g.value?(d(),p("div",ht,[o("div",gt,[(d(!0),p(x,null,$(i.value,(r,l)=>(d(),p("div",{key:l,class:"previa-bloque",style:z(E(r))},[o("h3",null,h(r.titulo||"Bloque sin título"),1),o("p",ft,h(r.subtitulo),1),o("div",mt,[(d(!0),p(x,null,$(q(r),v=>(d(),p("div",{key:v.uuid,class:"producto-previa"},[o("img",{src:C(v.imagenUrl),alt:""},null,8,_t),o("h4",null,h(v.titulo),1),o("p",wt,"$"+h(b(v)),1)]))),128))])],4))),128))])])):(d(),p("div",yt,[o("div",bt,[e[1]||(e[1]=o("h3",null,"📦 Productos Disponibles",-1)),o("div",xt,[(d(!0),p(x,null,$(B.value,r=>(d(),p("div",{key:r,class:"categoria"},[o("h4",{onClick:l=>D(r)},h(r)+" ("+h(y.value[r].length)+") ",9,$t),c.value===r?(d(),p("div",Ct,[(d(!0),p(x,null,$(y.value[r],l=>(d(),p("div",{key:l.uuid,class:"producto-item",draggable:"true",onDragstart:v=>m(v,l)},[o("img",{src:C(l.imagenUrl),alt:""},null,8,Bt),o("span",null,h(l.titulo),1)],40,kt))),128)),o("button",{class:"btn-add-categoria",onClick:l=>S(r)}," Añadir categoría completa ",8,qt)])):X("",!0)]))),128))])]),o("div",{class:"area-trabajo",ref_key:"workspace",ref:w,onDragover:e[0]||(e[0]=R(()=>{},["prevent"])),onDrop:A},[(d(!0),p(x,null,$(i.value,(r,l)=>(d(),Y(it,{key:r.id,bloque:r,productos:a.value,onUpdate:v=>n(l,v),onDelete:v=>u(l)},null,8,["bloque","productos","onUpdate","onDelete"]))),128))],544)]))])]))}}),St=L(Et,[["__scopeId","data-v-dfcb3388"]]);export{St as default};
